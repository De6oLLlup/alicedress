@model alicedress.Models.OrderViewModel
@{
    ViewData["Title"] = "Оформление заказа";
}

<div class="container py-5">
    <h1 class="mb-4">Оформление заказа</h1>

    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger">
            @TempData["Error"]
        </div>
    }

    <div class="row">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Данные для доставки</h5>

                    <form method="post" asp-action="PlaceOrder">
                        @Html.AntiForgeryToken()

                        @if (!ViewData.ModelState.IsValid)
                        {
                            <div class="alert alert-danger">
                                @foreach (var error in ViewData.ModelState.Values.SelectMany(v => v.Errors))
                                {
                                    <p>@error.ErrorMessage</p>
                                }
                            </div>
                        }

                        <div class="mb-3">
                            <label asp-for="CustomerName" class="form-label">ФИО *</label>
                            <input asp-for="CustomerName" class="form-control" />
                            <span asp-validation-for="CustomerName" class="text-danger"></span>
                        </div>

                        <div class="mb-3">
                            <label asp-for="CustomerEmail" class="form-label">Email *</label>
                            <input asp-for="CustomerEmail" class="form-control" />
                            <span asp-validation-for="CustomerEmail" class="text-danger"></span>
                        </div>

                        <div class="mb-3">
                            <label asp-for="CustomerPhone" class="form-label">Телефон *</label>
                            <input asp-for="CustomerPhone" class="form-control" />
                            <span asp-validation-for="CustomerPhone" class="text-danger"></span>
                        </div>

                        <div class="mb-3">
                            <label asp-for="ShippingAddress" class="form-label">Адрес доставки *</label>
                            <textarea asp-for="ShippingAddress" class="form-control" rows="3"></textarea>
                            <span asp-validation-for="ShippingAddress" class="text-danger"></span>
                        </div>

                        <div class="mb-3">
                            <label asp-for="DeliveryMethod" class="form-label">Способ доставки *</label>
                            <select asp-for="DeliveryMethod" class="form-select">
                                <option value="">Выберите способ доставки</option>
                                <option value="Самовывоз">Самовывоз (бесплатно)</option>
                                <option value="Курьер">Курьер (300 ₽)</option>
                                <option value="Почта России">Почта России (200 ₽)</option>
                                <option value="СДЭК">СДЭК (250 ₽)</option>
                            </select>
                            <span asp-validation-for="DeliveryMethod" class="text-danger"></span>
                        </div>

                        <div class="mb-3">
                            <label asp-for="PaymentMethod" class="form-label">Способ оплаты *</label>
                            <select asp-for="PaymentMethod" class="form-select">
                                <option value="">Выберите способ оплаты</option>
                                <option value="Наличными">Наличными при получении</option>
                                <option value="Картой">Картой при получении</option>
                                <option value="Онлайн">Онлайн оплата</option>
                            </select>
                            <span asp-validation-for="PaymentMethod" class="text-danger"></span>
                        </div>

                        <div class="mb-3">
                            <label asp-for="Comment" class="form-label">Комментарий к заказу</label>
                            <textarea asp-for="Comment" class="form-control" rows="2"></textarea>
                        </div>

                        <button type="submit" class="btn btn-success btn-lg">
                            Подтвердить заказ
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-lg-4 mt-4 mt-lg-0">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Ваш заказ</h5>

                    @if (ViewBag.CartItems != null)
                    {
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <tbody>
                                    @foreach (var item in ViewBag.CartItems)
                                    {
                                        <tr>
                                            <td>@item.ProductName</td>
                                            <td>@item.Quantity × @item.Price.ToString("N0") ₽</td>
                                            <td>@((item.Quantity * item.Price).ToString("N0")) ₽</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>

                        <hr>

                        <div class="d-flex justify-content-between mb-2">
                            <span>Товары:</span>
                            <span id="subTotal">@ViewBag.SubTotal.ToString("N0") ₽</span>
                        </div>

                        <div class="d-flex justify-content-between mb-2">
                            <span>Доставка:</span>
                            <span id="deliveryCost">@ViewBag.DeliveryCost.ToString("N0") ₽</span>
                        </div>

                        <hr>

                        <div class="d-flex justify-content-between fw-bold fs-5">
                            <span>Итого:</span>
                            <span id="totalAmount">@ViewBag.Total.ToString("N0") ₽</span>
                        </div>
                    }
                    else
                    {
                        <p class="text-muted">Нет товаров в корзине</p>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        $(document).ready(function() {
            // Обновляем стоимость доставки при изменении метода
            $('#DeliveryMethod').on('change', function() {
                calculateTotal();
            });

            function calculateTotal() {
                var deliveryMethod = $('#DeliveryMethod').val();

                $.ajax({
                    url: '@Url.Action("CalculateTotal", "Checkout")',
                    type: 'POST',
                    data: { deliveryMethod: deliveryMethod },
                    success: function(response) {
                        if (response.success) {
                            $('#deliveryCost').text(response.deliveryCost.toLocaleString('ru-RU') + ' ₽');
                            $('#totalAmount').text(response.total.toLocaleString('ru-RU') + ' ₽');
                        }
                    }
                });
            }
        });
    </script>
}